<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create a template background model &mdash; Gammapy recipes</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/gammapy.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery.css" type="text/css" /><link rel="shortcut icon" href="../../_static/gammapy_logo.ico"/>
    <link rel="canonical" href="https://gammapy.orgnotebooks/background-model/background_model.html"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "tex2jax_ignore|mathjax_ignore|document", "processClass": "tex2jax_process|mathjax_process|math|output_area"}})</script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="Dark matter spatial and spectral models" href="../dark-matter-utilities/astro_dark_matter.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Gammapy recipes
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
</ul>
<p class="caption"><span class="caption-text">Recipes</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../mcmc-sampling-emcee/mcmc_sampling.html">MCMC sampling using the emcee package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../mcmc-sampling-emcee/mcmc_sampling.html#Introduction">Introduction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../mcmc-sampling-emcee/mcmc_sampling.html#How-does-it-work-?">How does it work ?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mcmc-sampling-emcee/mcmc_sampling.html#Why-should-I-use-it-?">Why should I use it ?</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../mcmc-sampling-emcee/mcmc_sampling.html#Simulate-an-observation">Simulate an observation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mcmc-sampling-emcee/mcmc_sampling.html#Estimate-parameter-correlations-with-MCMC">Estimate parameter correlations with MCMC</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../mcmc-sampling-emcee/mcmc_sampling.html#Define-priors">Define priors</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../mcmc-sampling-emcee/mcmc_sampling.html#Plot-the-results">Plot the results</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mcmc-sampling-emcee/mcmc_sampling.html#Plot-the-model-dispersion">Plot the model dispersion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mcmc-sampling-emcee/mcmc_sampling.html#Fun-Zone">Fun Zone</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mcmc-sampling-emcee/mcmc_sampling.html#PeVatrons-in-CTA-?">PeVatrons in CTA ?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../interactive-model-editing/interactive-model-editing.html">Recipe to show the interactively edit the Sky model on the notebook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../interactive-model-editing/interactive-model-editing.html#Load-the-changed-parameters-and-verify-that-the-model-has-been-updated">Load the changed parameters and verify that the model has been updated</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../dark-matter-utilities/astro_dark_matter.html">Dark matter spatial and spectral models</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../dark-matter-utilities/astro_dark_matter.html#Introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dark-matter-utilities/astro_dark_matter.html#Setup">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dark-matter-utilities/astro_dark_matter.html#Profiles">Profiles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dark-matter-utilities/astro_dark_matter.html#J-Factors">J Factors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dark-matter-utilities/astro_dark_matter.html#Gamma-ray-spectra-at-production">Gamma-ray spectra at production</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dark-matter-utilities/astro_dark_matter.html#Flux-maps">Flux maps</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Create a template background model</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Context">Context</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Proposed-approach">Proposed approach</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Setup">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Select-off-data">Select off data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Background-model">Background model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Zenith-dependence">Zenith dependence</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Index-tables">Index tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Exercises">Exercises</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Gammapy recipes</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Create a template background model</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="admonition note">
<p class="admonition-title fa fa-exclamation-circle"><strong>This is a fixed-text formatted version of a Jupyter notebook</strong></p>
<ul class="simple">
<li><p><strong>Source files:</strong> <a class="reference external" href="../../_static/notebooks/background-model/background_model.ipynb">background_model.ipynb</a> | <a class="reference external" href="../../_static/notebooks/background-model/background_model.py">background_model.py</a></p></li>
<li><p><strong>Environment:</strong> <a class="reference external" href="../../_static/notebooks/background-model/env.yml">env.yml</a></p></li>
</ul>
</div>
<div class="section" id="Create-a-template-background-model">
<h1>Create a template background model<a class="headerlink" href="#Create-a-template-background-model" title="Permalink to this headline">¶</a></h1>
<div class="section" id="Context">
<h2>Context<a class="headerlink" href="#Context" title="Permalink to this headline">¶</a></h2>
<p>DL3 data is usually shipped with a background IRF. However, sometimes it is necessary to be able to build background templates from scratch.</p>
<p>In this notebook, we show a very basic example of how this can be done using off runs supplied within the HESS data release.</p>
<p>Real life implementations can be found <a class="reference external" href="https://www.aanda.org/articles/aa/abs/2019/12/aa36452-19/aa36452-19.html">here</a> and a slightly different approach <a class="reference external" href="https://www.aanda.org/articles/aa/full_html/2019/12/aa36010-19/aa36010-19.html">here</a>.</p>
</div>
<div class="section" id="Proposed-approach">
<h2>Proposed approach<a class="headerlink" href="#Proposed-approach" title="Permalink to this headline">¶</a></h2>
<p>We will use the “off observations”, i.e. those without significant gamma-ray emission sources in the field of view from the <a class="reference external" href="https://www.mpi-hd.mpg.de/hfm/HESS/pages/dl3-dr1/">H.E.S.S. first public test data release</a>. This model could then be used in the analysis of sources from that dataset (not done here).</p>
<p>We will make a background model that is radially symmetric in the field of view, i.e. only depends on field of view offset angle and energy. At the end, we will save the model in the <code class="docutils literal notranslate"><span class="pre">BKG_2D</span></code> as defined in the <a class="reference external" href="https://gamma-astro-data-formats.readthedocs.io/en/latest/irfs/full_enclosure/bkg/index.html">spec</a>.</p>
<p>Note that this is just a very simplified example. Actual background model production is done with more sophistication usually using 100s or 1000s of off runs, e.g. concerning non-radial symmetries, binning and smoothing of the distributions, and treating other dependencies such as zenith angle, telescope configuration or optical efficiency. Another aspect not shown here is how to use AGN observations to make background models, by cutting out the part of the field of view that contains gamma-rays
from the AGN.</p>
<p>We will mainly be using the following classes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">~gammapy.data.DataStore</span></code> to load the runs to use to build the bkg model.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">~gammapy.irf.Background2D</span></code> to represent and write the background model.</p></li>
</ul>
</div>
<div class="section" id="Setup">
<h2>Setup<a class="headerlink" href="#Setup" title="Permalink to this headline">¶</a></h2>
<p>As always, we start the notebook with some setup and imports.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">vstack</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">gammapy.maps</span> <span class="kn">import</span> <span class="n">MapAxis</span>
<span class="kn">from</span> <span class="nn">gammapy.data</span> <span class="kn">import</span> <span class="n">DataStore</span>
<span class="kn">from</span> <span class="nn">gammapy.irf</span> <span class="kn">import</span> <span class="n">Background2D</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Select-off-data">
<h2>Select off data<a class="headerlink" href="#Select-off-data" title="Permalink to this headline">¶</a></h2>
<p>We start by selecting the observations used to estimate the background model.</p>
<p>In this case, we just take all “off runs” as defined in the observation table.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">data_store</span> <span class="o">=</span> <span class="n">DataStore</span><span class="o">.</span><span class="n">from_dir</span><span class="p">(</span><span class="s2">&quot;$GAMMAPY_DATA/hess-dl3-dr1&quot;</span><span class="p">)</span>
<span class="c1"># Select just the off data runs</span>
<span class="n">obs_table</span> <span class="o">=</span> <span class="n">data_store</span><span class="o">.</span><span class="n">obs_table</span>
<span class="n">obs_table</span> <span class="o">=</span> <span class="n">obs_table</span><span class="p">[</span><span class="n">obs_table</span><span class="p">[</span><span class="s2">&quot;TARGET_NAME&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Off data&quot;</span><span class="p">]</span>
<span class="n">observations</span> <span class="o">=</span> <span class="n">data_store</span><span class="o">.</span><span class="n">get_observations</span><span class="p">(</span><span class="n">obs_table</span><span class="p">[</span><span class="s2">&quot;OBS_ID&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of observations:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observations</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
No HDU found matching: OBS_ID = 20275, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 20339, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 20561, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 20734, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 20915, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 21613, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 21753, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 21807, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 21824, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 21851, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 22022, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 22593, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 22997, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 23040, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 23077, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 23143, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 23246, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 23573, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 23635, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 23651, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 23736, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 25345, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 25443, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 25511, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 26077, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 26791, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 26827, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 26850, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 26964, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 27044, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 27121, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 27939, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 27987, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 28341, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 28967, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 28981, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 29024, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 29072, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 29118, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 29177, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 29433, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 29487, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 29526, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 29556, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 29683, HDU_TYPE = rad_max, HDU_CLASS = None
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Number of observations: 45
</pre></div></div>
</div>
</div>
<div class="section" id="Background-model">
<h2>Background model<a class="headerlink" href="#Background-model" title="Permalink to this headline">¶</a></h2>
<p>The background model we will estimate is a differential background rate model in unit <code class="docutils literal notranslate"><span class="pre">s-1</span> <span class="pre">MeV-1</span> <span class="pre">sr-1</span></code> as a function of reconstructed energy and field of fiew offset.</p>
<p>We estimate it by histogramming off data events and then smoothing a bit (not using a good method) to get a less noisy estimate. To get the differential rate, we divide by observation time and also take bin sizes into account to get the rate per energy and solid angle. So overall we fill two arrays called <code class="docutils literal notranslate"><span class="pre">counts</span></code> and <code class="docutils literal notranslate"><span class="pre">exposure</span></code> with <code class="docutils literal notranslate"><span class="pre">exposure</span></code> filled so that <code class="docutils literal notranslate"><span class="pre">background_rate</span> <span class="pre">=</span> <span class="pre">counts</span> <span class="pre">/</span> <span class="pre">exposure</span></code> will give the final background rate we’re interested in.</p>
<p>The processing can be done either one observation at a time, or first for counts and then for exposure. Either way is fine. Here we do one observation at a time, starting with empty histograms and then accumulating counts and exposure. Since this is a multi-step algorithm, we put the code to do this computation in a <code class="docutils literal notranslate"><span class="pre">BackgroundModelEstimator</span></code> class.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">BackgroundModelEstimator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_bkg2d</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exposure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_bkg2d</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;s MeV sr&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_make_bkg2d</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">energy</span><span class="o">.</span><span class="n">center</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">offset</span><span class="o">.</span><span class="n">center</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Background2D</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">energy</span><span class="p">,</span> <span class="n">offset</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observations</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">observations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fill_counts</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fill_exposure</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fill_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">):</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">events</span>
        <span class="n">energy_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">edges</span>
        <span class="n">offset_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s2">&quot;offset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">edges</span>

        <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">events</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;MeV&quot;</span><span class="p">),</span>
            <span class="n">y</span><span class="o">=</span><span class="n">events</span><span class="o">.</span><span class="n">offset</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;deg&quot;</span><span class="p">),</span>
            <span class="n">bins</span><span class="o">=</span><span class="p">(</span><span class="n">energy_bins</span><span class="p">,</span> <span class="n">offset_bins</span><span class="p">),</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">data</span> <span class="o">+=</span> <span class="n">counts</span>

    <span class="k">def</span> <span class="nf">fill_exposure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">):</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">axes</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="s2">&quot;offset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">center</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">observation_time_duration</span>
        <span class="n">exposure</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">offset</span> <span class="o">*</span> <span class="n">time</span> <span class="o">*</span> <span class="n">axes</span><span class="o">.</span><span class="n">bin_volume</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">quantity</span> <span class="o">+=</span> <span class="n">exposure</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">background_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rate</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counts</span><span class="p">)</span>
        <span class="n">rate</span><span class="o">.</span><span class="n">quantity</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">quantity</span>
        <span class="k">return</span> <span class="n">rate</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="n">energy</span> <span class="o">=</span> <span class="n">MapAxis</span><span class="o">.</span><span class="n">from_energy_bounds</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TeV&quot;</span><span class="p">)</span>
<span class="n">offset</span> <span class="o">=</span> <span class="n">MapAxis</span><span class="o">.</span><span class="n">from_bounds</span><span class="p">(</span>
    <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s2">&quot;sqrt&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;offset&quot;</span>
<span class="p">)</span>
<span class="n">estimator</span> <span class="o">=</span> <span class="n">BackgroundModelEstimator</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
<span class="n">estimator</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 1.16 s, sys: 29.6 ms, total: 1.19 s
Wall time: 1.21 s
</pre></div></div>
</div>
<p>Let’s have a quick look at what we did …</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">estimator</span><span class="o">.</span><span class="n">background_rate</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_background-model_background_model_12_0.png" src="../../_images/notebooks_background-model_background_model_12_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># You could save the background model to a file like this</span>
<span class="c1"># estimator.background_rate.to_fits().writeto(&#39;background_model.fits&#39;, overwrite=True)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Zenith-dependence">
<h2>Zenith dependence<a class="headerlink" href="#Zenith-dependence" title="Permalink to this headline">¶</a></h2>
<p>The background models used in H.E.S.S. usually depend on the zenith angle of the observation. That kinda makes sense because the energy threshold increases with zenith angle, and since the background is related to (but not given by) the charged cosmic ray spectrum that is a power-law and falls steeply, we also expect the background rate to change.</p>
<p>Let’s have a look at the dependence we get for this configuration used here (Hillas reconstruction, standard cuts, see H.E.S.S. release notes for more information).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">x</span> <span class="o">=</span> <span class="n">obs_table</span><span class="p">[</span><span class="s2">&quot;ZEN_PNT&quot;</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">obs_table</span><span class="p">[</span><span class="s2">&quot;SAFE_ENERGY_LO&quot;</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Zenith (deg)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Energy threshold (TeV)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_background-model_background_model_15_0.png" src="../../_images/notebooks_background-model_background_model_15_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">x</span> <span class="o">=</span> <span class="n">obs_table</span><span class="p">[</span><span class="s2">&quot;ZEN_PNT&quot;</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">obs_table</span><span class="p">[</span><span class="s2">&quot;EVENT_COUNT&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">obs_table</span><span class="p">[</span><span class="s2">&quot;ONTIME&quot;</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Zenith (deg)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Rate (events / sec)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_background-model_background_model_16_0.png" src="../../_images/notebooks_background-model_background_model_16_0.png" />
</div>
</div>
<p>The energy threshold increases, as expected. It’s a bit surprising that the total background rate doesn’t decreases with increasing zenith angle. That’s a bit of luck for this configuration, and because we’re looking at the rate of background events in the whole field of view. As shown below, the energy threshold increases (reducing the total rate), but the rate at a given energy increases with zenith angle (increasing the total rate). Overall the background does change with zenith angle and
that dependency should be taken into account.</p>
<p>The remaining scatter you see in the plots above (in energy threshold and rate) is due to dependence on telescope optical efficiency, atmospheric changes from run to run and other effects. If you’re interested in this, <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2014APh....54...25H">2014APh….54…25H</a> has some infos. We’ll not consider this futher.</p>
<p>When faced with the question whether and how to model the zenith angle dependence, we’re faced with a complex optimisation problem: the closer we require off runs to be in zenith angle, the fewer off runs and thus event statistic we have available, which will lead do noise in the background model. The choice of zenith angle binning or “on-off observation mathching” strategy isn’t the only thing that needs to be optimised, there’s also energy and offset binnings and smoothing scales. And of
course good settings will depend on the way you plan to use the background model, i.e. the science measurement you plan to do. Some say background modeling is the hardest part of IACT data analysis.</p>
<p>Here we’ll just code up something simple: make three background models, one from the off runs with zenith angle 0 to 20 deg, one from 20 to 40 deg, and one from 40 to 90 deg.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">zenith_bins</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="mi">90</span><span class="p">},</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">make_model</span><span class="p">(</span><span class="n">observations</span><span class="p">):</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="n">MapAxis</span><span class="o">.</span><span class="n">from_energy_bounds</span><span class="p">(</span>
        <span class="mf">0.1</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TeV&quot;</span>
    <span class="p">)</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">MapAxis</span><span class="o">.</span><span class="n">from_bounds</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s2">&quot;sqrt&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;offset&quot;</span>
    <span class="p">)</span>
    <span class="n">estimator</span> <span class="o">=</span> <span class="n">BackgroundModelEstimator</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
    <span class="n">estimator</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">estimator</span><span class="o">.</span><span class="n">background_rate</span>


<span class="k">def</span> <span class="nf">make_models</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">zenith</span> <span class="ow">in</span> <span class="n">zenith_bins</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">zenith</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">obs_table</span><span class="p">[</span><span class="s2">&quot;ZEN_PNT&quot;</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">obs_table</span><span class="p">[</span><span class="s2">&quot;ZEN_PNT&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">zenith</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span>
        <span class="n">obs_ids</span> <span class="o">=</span> <span class="n">obs_table</span><span class="p">[</span><span class="s2">&quot;OBS_ID&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">observations</span> <span class="o">=</span> <span class="n">data_store</span><span class="o">.</span><span class="n">get_observations</span><span class="p">(</span><span class="n">obs_ids</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">make_model</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="n">models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">make_models</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
No HDU found matching: OBS_ID = 21753, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 21807, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 21824, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 26850, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 26964, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 27044, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 27121, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 27939, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 29024, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 29118, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 29487, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 20275, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 20339, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 20561, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 20734, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 20915, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 21613, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 22593, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 22997, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 23040, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 23077, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 23143, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 23246, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 23573, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 23635, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 23651, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 25345, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 25443, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 25511, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 27987, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 28341, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 28967, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 28981, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 29072, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 29177, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 29556, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 21851, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 22022, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 23736, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 26077, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 26791, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 26827, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 29433, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 29526, HDU_TYPE = rad_max, HDU_CLASS = None
No HDU found matching: OBS_ID = 29683, HDU_TYPE = rad_max, HDU_CLASS = None
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 1.45 s, sys: 82.1 ms, total: 1.54 s
Wall time: 1.23 s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_background-model_background_model_20_0.png" src="../../_images/notebooks_background-model_background_model_20_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">models</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_background-model_background_model_21_0.png" src="../../_images/notebooks_background-model_background_model_21_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">y</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">energy</span><span class="o">=</span><span class="n">energy</span><span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s2">&quot;0.5 deg&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energy</span><span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;0 &lt; zen &lt; 20&quot;</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">energy</span><span class="o">=</span><span class="n">energy</span><span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s2">&quot;0.5 deg&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energy</span><span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;20 &lt; zen &lt; 40&quot;</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">energy</span><span class="o">=</span><span class="n">energy</span><span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="s2">&quot;0.5 deg&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energy</span><span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;40 &lt; zen &lt; 90&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Energy (TeV)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Bkg rate (s-1 sr-1 MeV-1)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_background-model_background_model_22_0.png" src="../../_images/notebooks_background-model_background_model_22_0.png" />
</div>
</div>
</div>
<div class="section" id="Index-tables">
<h2>Index tables<a class="headerlink" href="#Index-tables" title="Permalink to this headline">¶</a></h2>
<p>So now we have radially symmetric background models for three zenith angle bins. To be able to use it from the high-level Gammapy classes like e.g. the MapMaker though, we also have to create a <a class="reference external" href="https://gamma-astro-data-formats.readthedocs.io/en/latest/data_storage/hdu_index/index.html">HDU index table</a> that declares which background model to use for each observation.</p>
<p>It sounds harder than it actually is. Basically you have to some code to make a new <code class="docutils literal notranslate"><span class="pre">astropy.table.Table</span></code>. The most tricky part is that before you can make the HDU index table, you have to decide where to store the data, because the HDU index table is a reference to the data location. Let’s decide in this example that we want to re-use all existing files in <code class="docutils literal notranslate"><span class="pre">$GAMMAPY_DATA/hess-dl3-dr1</span></code> and put all the new HDUs (for background models and new index files) bundled in a single FITS file called
<code class="docutils literal notranslate"><span class="pre">hess-dl3-dr3-with-background.fits.gz</span></code>, which we will put in <code class="docutils literal notranslate"><span class="pre">$GAMMAPY_DATA/hess-dl3-dr1</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;hess-dl3-dr3-with-background.fits.gz&quot;</span>

<span class="c1"># Make a new table with one row for each observation</span>
<span class="c1"># pointing to the background model HDU</span>
<span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">obs_row</span> <span class="ow">in</span> <span class="n">data_store</span><span class="o">.</span><span class="n">obs_table</span><span class="p">:</span>
    <span class="n">row</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;OBS_ID&quot;</span><span class="p">:</span> <span class="n">obs_row</span><span class="p">[</span><span class="s2">&quot;OBS_ID&quot;</span><span class="p">],</span>
        <span class="s2">&quot;HDU_TYPE&quot;</span><span class="p">:</span> <span class="s2">&quot;bkg&quot;</span><span class="p">,</span>
        <span class="s2">&quot;HDU_CLASS&quot;</span><span class="p">:</span> <span class="s2">&quot;bkg_2d&quot;</span><span class="p">,</span>
        <span class="s2">&quot;FILE_DIR&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;FILE_NAME&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
        <span class="s2">&quot;HDU_NAME&quot;</span><span class="p">:</span> <span class="s2">&quot;BKG0&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

<span class="n">hdu_table_bkg</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Make a copy of the original HDU index table</span>
<span class="n">hdu_table</span> <span class="o">=</span> <span class="n">data_store</span><span class="o">.</span><span class="n">hdu_table</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">hdu_table</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;BASE_DIR&quot;</span><span class="p">)</span>

<span class="c1"># Add the rows for the background HDUs</span>
<span class="n">hdu_table</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">([</span><span class="n">hdu_table</span><span class="p">,</span> <span class="n">hdu_table_bkg</span><span class="p">])</span>
<span class="n">hdu_table</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;OBS_ID&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">hdu_table</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div><i>HDUIndexTable length=6</i>
<table id="table4933064256" class="table-striped table-bordered table-condensed">
<thead><tr><th>OBS_ID</th><th>HDU_TYPE</th><th>HDU_CLASS</th><th>FILE_DIR</th><th>FILE_NAME</th><th>HDU_NAME</th><th>SIZE</th></tr></thead>
<thead><tr><th>int64</th><th>str6</th><th>str9</th><th>str4</th><th>str36</th><th>str6</th><th>int64</th></tr></thead>
<tr><td>20137</td><td>bkg</td><td>bkg_3d</td><td>data</td><td>hess_dl3_dr1_obs_id_020137.fits.gz</td><td>bkg</td><td>207360</td></tr>
<tr><td>20137</td><td>edisp</td><td>edisp_2d</td><td>data</td><td>hess_dl3_dr1_obs_id_020137.fits.gz</td><td>edisp</td><td>377280</td></tr>
<tr><td>20137</td><td>events</td><td>events</td><td>data</td><td>hess_dl3_dr1_obs_id_020137.fits.gz</td><td>events</td><td>216000</td></tr>
<tr><td>20137</td><td>gti</td><td>gti</td><td>data</td><td>hess_dl3_dr1_obs_id_020137.fits.gz</td><td>gti</td><td>5760</td></tr>
<tr><td>20137</td><td>psf</td><td>psf_table</td><td>data</td><td>hess_dl3_dr1_obs_id_020137.fits.gz</td><td>psf</td><td>118080</td></tr>
<tr><td>20137</td><td>bkg</td><td>bkg_2d</td><td></td><td>hess-dl3-dr3-with-background.fits.gz</td><td>BKG0</td><td>--</td></tr>
</table></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Put index tables and background models in a FITS file</span>
<span class="n">hdu_list</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">()</span>

<span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="p">(</span><span class="n">hdu_table</span><span class="p">)</span>
<span class="n">hdu</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;HDU_INDEX&quot;</span>
<span class="n">hdu_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdu</span><span class="p">)</span>

<span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="p">(</span><span class="n">data_store</span><span class="o">.</span><span class="n">obs_table</span><span class="p">)</span>
<span class="n">hdu_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdu</span><span class="p">)</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
    <span class="n">hdu</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to_table_hdu</span><span class="p">()</span>
    <span class="n">hdu</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;BKG</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">hdu_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdu</span><span class="p">)</span>

<span class="nb">print</span><span class="p">([</span><span class="n">_</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">hdu_list</span><span class="p">])</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="n">path</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;GAMMAPY_DATA&quot;</span><span class="p">])</span>
    <span class="o">/</span> <span class="s2">&quot;hess-dl3-dr1/hess-dl3-dr3-with-background.fits.gz&quot;</span>
<span class="p">)</span>
<span class="n">hdu_list</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;PRIMARY&#39;, &#39;HDU_INDEX&#39;, &#39;OBS_INDEX&#39;, &#39;BKG0&#39;, &#39;BKG1&#39;, &#39;BKG2&#39;]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Let&#39;s see if it&#39;s possible to access the data</span>
<span class="n">ds2</span> <span class="o">=</span> <span class="n">DataStore</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="n">ds2</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
<span class="n">obs</span> <span class="o">=</span> <span class="n">ds2</span><span class="o">.</span><span class="n">obs</span><span class="p">(</span><span class="mi">20137</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Found multiple HDU matching: OBS_ID = 20137, HDU_TYPE = bkg, HDU_CLASS = None. Returning the first entry, which has HDU_TYPE = bkg and HDU_CLASS = bkg_3d
No HDU found matching: OBS_ID = 20137, HDU_TYPE = rad_max, HDU_CLASS = None
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Data store:
HDU index table:
BASE_DIR: /Users/adonath/github/gammapy/gammapy-data/hess-dl3-dr1
Rows: 735
OBS_ID: 20136 -- 47829
HDU_TYPE: [&#39;aeff&#39;, &#39;bkg&#39;, &#39;edisp&#39;, &#39;events&#39;, &#39;gti&#39;, &#39;psf&#39;]
HDU_CLASS: [&#39;aeff_2d&#39;, &#39;bkg_2d&#39;, &#39;bkg_3d&#39;, &#39;edisp_2d&#39;, &#39;events&#39;, &#39;gti&#39;, &#39;psf_table&#39;]


Observation table:
Observatory name: &#39;N/A&#39;
Number of observations: 105

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># the events</span>
<span class="n">obs</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">select_offset</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_background-model_background_model_29_0.png" src="../../_images/notebooks_background-model_background_model_29_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># the effective area</span>
<span class="n">obs</span><span class="o">.</span><span class="n">aeff</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/adonath/software/mambaforge/envs/gammapy-dev/lib/python3.9/site-packages/astropy/units/quantity.py:486: RuntimeWarning: invalid value encountered in true_divide
  result = super().__array_ufunc__(function, method, *arrays, **kwargs)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_background-model_background_model_30_1.png" src="../../_images/notebooks_background-model_background_model_30_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># the background</span>
<span class="n">obs</span><span class="o">.</span><span class="n">bkg</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_background-model_background_model_31_0.png" src="../../_images/notebooks_background-model_background_model_31_0.png" />
</div>
</div>
</div>
<div class="section" id="Exercises">
<h2>Exercises<a class="headerlink" href="#Exercises" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Play with the parameters here (energy binning, offset binning, zenith binning)</p></li>
<li><p>Try to figure out why there are outliers on the zenith vs energy threshold curve.</p></li>
<li><p>Does azimuth angle or optical efficiency have an effect on background rate?</p></li>
<li><p>Use the background models for a 3D analysis (see “hess” notebook).</p></li>
</ul>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../dark-matter-utilities/astro_dark_matter.html" class="btn btn-neutral float-left" title="Dark matter spatial and spectral models" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Gammapy recipes contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>